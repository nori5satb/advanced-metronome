# Advanced Metronome App 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Advanced Metronome App

### 1.2 プロジェクトの目的
楽曲の進行に合わせてテンポや拍子が自動変更される高機能メトロノームアプリケーションを開発し、音楽練習の効率向上を図る。

### 1.3 ターゲットユーザー
- 音楽学習者（学生、アマチュア演奏者）
- 音楽教育者（音楽教師、指導者）
- プロの音楽家
- 音楽愛好家

## 2. 機能要件

### 2.1 基本メトロノーム機能

#### 2.1.1 テンポ制御
- **優先度**: 高
- **概要**: メトロノームのテンポを設定・変更する機能
- **詳細要件**:
  - テンポ範囲: 30-300 BPM
  - 1 BPM単位での細かい調整
  - リアルタイムでのテンポ変更
  - テンポ表示（数値・視覚的表示）

#### 2.1.2 拍子設定
- **優先度**: 高
- **概要**: 楽曲の拍子に応じたリズムパターンを設定
- **詳細要件**:
  - 対応拍子: 2/4, 3/4, 4/4, 5/4, 6/8, 7/8, 9/8など
  - 強拍の視覚・聴覚的強調
  - カスタム拍子の設定可能

#### 2.1.3 音色・音響設定
- **優先度**: 中
- **概要**: メトロノーム音の種類と音量を調整
- **詳細要件**:
  - 音色種類: クリック音、ビープ音、ウッドブロック、電子音等
  - 強拍・弱拍の音色差別化
  - 音量調整（0-100%）
  - ミュート機能

#### 2.1.4 視覚的フィードバック
- **優先度**: 中
- **概要**: 音響以外の視覚的なリズム表示
- **詳細要件**:
  - 拍ごとの点滅表示
  - 強拍の色分け表示
  - アニメーション効果
  - 小節カウンター表示

### 2.2 楽曲情報管理機能

#### 2.2.1 楽曲セクション登録
- **優先度**: 高
- **概要**: 楽曲の各セクションごとにテンポ・拍子を設定
- **詳細要件**:
  - セクション名の設定（イントロ、Aメロ、サビ等）
  - 各セクションの小節範囲指定
  - セクションごとのテンポ設定
  - セクションごとの拍子設定
  - セクションの追加・編集・削除
  - セクション順序の変更

#### 2.2.2 楽曲メタデータ管理
- **優先度**: 中
- **概要**: 楽曲の基本情報を管理
- **詳細要件**:
  - 楽曲タイトル
  - 作曲者・アーティスト名
  - ジャンル
  - 難易度レベル
  - 作成日・更新日
  - 楽曲の説明・メモ

#### 2.2.3 自動進行機能
- **優先度**: 高
- **概要**: 設定された楽曲情報に基づく自動的なメトロノーム変更
- **詳細要件**:
  - セクション切り替えの自動実行
  - テンポ・拍子の自動変更
  - 進行状況の表示
  - 現在位置の視覚的表示

### 2.3 練習支援機能

#### 2.3.1 一括テンポ調整
- **優先度**: 高
- **概要**: 全セクションのテンポを一括で調整する機能
- **詳細要件**:
  - 倍率指定（0.5x - 2.0x, 0.1x刻み）
  - セクション別の除外設定
  - 調整前後のテンポ比較表示
  - 調整の保存・復元

#### 2.3.2 部分練習機能
- **優先度**: 高
- **概要**: 指定した箇所からの練習開始機能
- **詳細要件**:
  - 開始小節の指定
  - セクション単位での練習
  - ループ再生機能
  - 練習範囲の保存

#### 2.3.3 カウントイン機能
- **優先度**: 高
- **概要**: メトロノーム開始前の予備拍提供
- **詳細要件**:
  - 1小節分のカウントイン
  - カウントイン中の視覚的表示
  - カウントイン音の設定
  - カウントイン無効化オプション

### 2.4 楽譜読み取り機能

#### 2.4.1 画像アップロード
- **優先度**: 中
- **概要**: 楽譜画像・PDFファイルのアップロード機能
- **詳細要件**:
  - 対応形式: JPEG, PNG, PDF
  - ファイルサイズ制限: 10MB
  - 複数ページPDFの対応
  - プレビュー機能

#### 2.4.2 自動解析機能
- **優先度**: 低
- **概要**: アップロードされた楽譜からの情報自動抽出
- **詳細要件**:
  - テンポ記号の認識
  - 拍子記号の認識
  - 小節線の検出
  - セクション境界の推定
  - 信頼度スコアの表示

#### 2.4.3 手動補正機能
- **優先度**: 中
- **概要**: 自動解析結果の手動修正機能
- **詳細要件**:
  - 解析結果の編集
  - 未検出項目の手動追加
  - 誤検出項目の削除・修正
  - 解析結果のプレビュー

### 2.5 ユーザー管理機能

#### 2.5.1 ユーザー認証
- **優先度**: 中
- **概要**: ユーザーアカウントの作成・管理
- **詳細要件**:
  - メールアドレスによる登録
  - パスワード認証
  - OAuth認証（Google, Apple）
  - パスワードリセット機能
  - アカウント削除機能

#### 2.5.2 データ同期
- **優先度**: 中
- **概要**: ユーザーデータのクラウド同期
- **詳細要件**:
  - 楽曲データの自動バックアップ
  - 複数デバイス間での同期
  - オフライン時のローカル保存
  - 同期状況の表示

### 2.6 共有・コラボレーション機能

#### 2.6.1 楽曲データ共有
- **優先度**: 低
- **概要**: 作成した楽曲情報の他ユーザーとの共有
- **詳細要件**:
  - 公開・非公開設定
  - 共有リンクの生成
  - 楽曲データのエクスポート/インポート
  - 共有権限の管理

#### 2.6.2 コミュニティ機能
- **優先度**: 低
- **概要**: ユーザー間での楽曲データ交換
- **詳細要件**:
  - 楽曲ライブラリの検索
  - レーティング・レビュー機能
  - お気に入り登録
  - 使用統計の表示

## 3. 非機能要件

### 3.1 レスポンシブデザイン

#### 3.1.1 モバイル最優先設計
- **優先度**: 高
- **概要**: スマートフォンでの使用を最優先とした UI/UX
- **詳細要件**:
  - タッチ操作に最適化されたインターフェース
  - 画面サイズに応じたレスポンシブ対応
  - 片手操作への配慮
  - 大きなタップターゲット（44px以上）

#### 3.1.2 対応デバイス・ブラウザ
- **優先度**: 高
- **詳細要件**:
  - iOS Safari（最新2バージョン）
  - Android Chrome（最新2バージョン）
  - デスクトップ: Chrome, Firefox, Safari, Edge（最新2バージョン）
  - 画面サイズ: 320px - 2560px

### 3.2 パフォーマンス

#### 3.2.1 応答性能
- **優先度**: 高
- **詳細要件**:
  - メトロノーム音の遅延: 10ms以下
  - UI操作の応答時間: 100ms以下
  - 初回ページロード時間: 3秒以下
  - Lighthouseスコア: 90点以上

#### 3.2.2 音響品質
- **優先度**: 高
- **詳細要件**:
  - オーディオサンプルレート: 44.1kHz
  - ビット深度: 16bit以上
  - 音の歪み・ノイズの最小化
  - 音量の一貫性確保

### 3.3 可用性・信頼性

#### 3.3.1 アップタイム
- **優先度**: 中
- **詳細要件**:
  - サービス稼働率: 99.5%以上
  - 計画メンテナンス: 月1回、2時間以内
  - 障害復旧時間: 4時間以内

#### 3.3.2 データ保護
- **優先度**: 高
- **詳細要件**:
  - データの自動バックアップ（日次）
  - データ暗号化（保存時・転送時）
  - データ復旧手順の確立

### 3.4 セキュリティ

#### 3.4.1 認証・認可
- **優先度**: 中
- **詳細要件**:
  - パスワードのハッシュ化保存
  - セッション管理の適切な実装
  - CSRF対策の実装
  - 不正アクセス検知・防御

#### 3.4.2 データプライバシー
- **優先度**: 高
- **詳細要件**:
  - 個人情報の最小限収集
  - データ削除権の保証
  - 第三者とのデータ共有の明示
  - プライバシーポリシーの整備

## 4. 技術要件

### 4.1 技術スタック

#### 4.1.1 フロントエンド
- **フレームワーク**: React 18+
- **ルーティング**: React Router v7
- **スタイリング**: Tailwind CSS
- **状態管理**: React Context API / Zustand
- **TypeScript**: 5.0+

#### 4.1.2 バックエンド
- **ランタイム**: Cloudflare Workers
- **データベース**: SQLite (Cloudflare D1)
- **認証**: Cloudflare Access / Auth0
- **ファイルストレージ**: Cloudflare R2

#### 4.1.3 ビルド・開発環境
- **バンドラー**: Vite
- **テストフレームワーク**: Vitest
- **E2Eテスト**: Playwright
- **リンター**: ESLint
- **フォーマッター**: Prettier

#### 4.1.4 デプロイ・インフラ
- **CDN・ホスティング**: Cloudflare Pages
- **API**: Cloudflare Workers
- **ドメイン管理**: Cloudflare DNS
- **監視**: Cloudflare Analytics

### 4.2 API設計

#### 4.2.1 RESTful API
- **ベースURL**: `https://api.metronome-app.com/v1`
- **認証方式**: Bearer Token (JWT)
- **レスポンス形式**: JSON
- **エラーハンドリング**: HTTP ステータスコード + エラーメッセージ

#### 4.2.2 主要エンドポイント
```
GET    /users/profile          - ユーザー情報取得
PUT    /users/profile          - ユーザー情報更新
GET    /songs                  - 楽曲一覧取得
POST   /songs                  - 楽曲作成
GET    /songs/{id}             - 楽曲詳細取得
PUT    /songs/{id}             - 楽曲更新
DELETE /songs/{id}             - 楽曲削除
POST   /songs/{id}/share       - 楽曲共有
POST   /scores/analyze         - 楽譜解析
GET    /shared/songs           - 共有楽曲一覧
```

### 4.3 データベース設計

#### 4.3.1 主要テーブル
```sql
-- ユーザーテーブル
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 楽曲テーブル
CREATE TABLE songs (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    title TEXT NOT NULL,
    artist TEXT,
    genre TEXT,
    difficulty INTEGER,
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- セクションテーブル
CREATE TABLE sections (
    id TEXT PRIMARY KEY,
    song_id TEXT NOT NULL,
    name TEXT NOT NULL,
    start_measure INTEGER NOT NULL,
    end_measure INTEGER NOT NULL,
    tempo INTEGER NOT NULL,
    time_signature_numerator INTEGER NOT NULL,
    time_signature_denominator INTEGER NOT NULL,
    exclude_speed_change BOOLEAN DEFAULT FALSE,
    order_index INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (song_id) REFERENCES songs(id)
);

-- 楽譜ファイルテーブル
CREATE TABLE score_files (
    id TEXT PRIMARY KEY,
    song_id TEXT NOT NULL,
    filename TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    storage_key TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (song_id) REFERENCES songs(id)
);
```

## 5. 開発計画

### 5.1 開発フェーズ

#### Phase 1: 基本機能開発（4週間）
- 基本メトロノーム機能
- 楽曲セクション管理
- レスポンシブUI
- 基本的なテスト実装

#### Phase 2: 練習支援機能（3週間）
- 一括テンポ調整
- 部分練習機能
- カウントイン機能
- UI/UX改善

#### Phase 3: ユーザー管理・認証（3週間）
- ユーザー認証システム
- データ同期機能
- セキュリティ実装
- パフォーマンス最適化

#### Phase 4: 楽譜読み取り機能（4週間）
- 画像アップロード機能
- 楽譜解析エンジン
- 手動補正機能
- 精度向上・最適化

#### Phase 5: 共有・コミュニティ機能（2週間）
- 楽曲共有機能
- コミュニティ機能
- 最終的なテスト・修正
- リリース準備

### 5.2 テスト戦略

#### 5.2.1 単体テスト
- **カバレッジ目標**: 80%以上
- **ツール**: Vitest
- **対象**: ユーティリティ関数、コンポーネントロジック

#### 5.2.2 統合テスト
- **ツール**: Vitest + Testing Library
- **対象**: コンポーネント間の連携、API通信

#### 5.2.3 E2Eテスト
- **ツール**: Playwright
- **対象**: 主要ユーザーフロー
- **実行環境**: CI/CD パイプライン

#### 5.2.4 パフォーマンステスト
- **音響遅延測定**: 専用テストスイート
- **負荷テスト**: Cloudflare Load Testing
- **モバイル性能**: Lighthouse CI

## 6. リスク・制約事項

### 6.1 技術的リスク
- **Web Audio API制限**: ブラウザごとの音響処理の差異
- **モバイル音響遅延**: モバイルデバイスでの音響処理遅延
- **楽譜認識精度**: OCR技術の限界による認識精度の問題

### 6.2 運用リスク
- **Cloudflare依存**: 単一クラウドプロバイダーへの依存
- **ユーザー獲得**: 競合サービスとの差別化
- **著作権問題**: 楽譜共有における著作権の取り扱い

### 6.3 制約事項
- **予算制限**: 開発・運用コストの制約
- **開発期間**: 16週間での完成目標
- **チーム規模**: 少人数開発チームでの実装

## 7. 成功指標

### 7.1 技術指標
- メトロノーム音遅延: 10ms以下
- Lighthouseスコア: 90点以上
- アプリケーションクラッシュ率: 0.1%以下
- API応答時間: 200ms以下

### 7.2 ユーザー指標
- 月間アクティブユーザー: 1,000人（6ヶ月後）
- ユーザー継続率: 30%（1ヶ月後）
- 楽曲作成数: 平均3曲/ユーザー
- アプリストア評価: 4.0星以上

### 7.3 ビジネス指標
- ユーザー獲得コスト: $10以下
- サーバー運用コスト: $100/月以下
- 機能利用率: 基本機能80%以上、高度機能30%以上